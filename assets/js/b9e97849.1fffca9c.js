"use strict";(self.webpackChunk_polywrap_docs=self.webpackChunk_polywrap_docs||[]).push([[3883],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>y});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function p(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var i=r.createContext({}),s=function(e){var t=r.useContext(i),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},u=function(e){var t=s(e.components);return r.createElement(i.Provider,{value:t},e.children)},c="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,i=e.parentName,u=p(e,["components","mdxType","originalType","parentName"]),c=s(n),d=a,y=c["".concat(i,".").concat(d)]||c[d]||m[d]||o;return n?r.createElement(y,l(l({ref:t},u),{},{components:n})):r.createElement(y,l({ref:t},u))}));function y(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,l=new Array(o);l[0]=d;var p={};for(var i in t)hasOwnProperty.call(t,i)&&(p[i]=t[i]);p.originalType=e,p[c]="string"==typeof e?e:a,l[1]=p;for(var s=2;s<o;s++)l[s]=n[s];return r.createElement.apply(null,l)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},7576:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>i,contentTitle:()=>l,default:()=>m,frontMatter:()=>o,metadata:()=>p,toc:()=>s});var r=n(7462),a=(n(7294),n(3905));const o={id:"in-typescript",title:"Test Wraps In TypeScript"},l=void 0,p={unversionedId:"tutorials/test-wraps/in-typescript",id:"tutorials/test-wraps/in-typescript",title:"Test Wraps In TypeScript",description:"Introduction",source:"@site/docs/tutorials/test-wraps/in-typescript.md",sourceDirName:"tutorials/test-wraps",slug:"/tutorials/test-wraps/in-typescript",permalink:"/tutorials/test-wraps/in-typescript",draft:!1,editUrl:"https://github.com/polywrap/documentation/tree/main/src/docs/tutorials/test-wraps/in-typescript.md",tags:[],version:"current",frontMatter:{id:"in-typescript",title:"Test Wraps In TypeScript"},sidebar:"docs",previous:{title:"Default plugins",permalink:"/tutorials/create-wraps/default-plugins"},next:{title:"Configure Polywrap infrastructure pipeline",permalink:"/tutorials/test-wraps/infra-pipeline"}},i={},s=[{value:"<strong>Introduction</strong>",id:"introduction",level:2},{value:"<strong>Prerequisites</strong>",id:"prerequisites",level:2},{value:"<strong>Project Setup</strong>",id:"project-setup",level:2},{value:"<strong>Build The Wrap</strong>",id:"build-the-wrap",level:2},{value:"<strong>Configure a Polywrap Client</strong>",id:"configure-a-polywrap-client",level:2},{value:"<strong>Load The Wrap</strong>",id:"load-the-wrap",level:2},{value:"<strong>Test Your Wrap</strong>",id:"test-your-wrap",level:2},{value:"<strong>Type Safety</strong>",id:"type-safety",level:2},{value:"<strong>Conclusion</strong>",id:"conclusion",level:2}],u={toc:s},c="wrapper";function m(e){let{components:t,...n}=e;return(0,a.kt)(c,(0,r.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"introduction"},(0,a.kt)("strong",{parentName:"h2"},"Introduction")),(0,a.kt)("p",null,"In this tutorial we'll learn how to develop custom end to end (e2e) tests for your wrap in TypeScript. These tests will be make calls into your wrap using the ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/polywrap/javascript-client"},"JavaScript / TypeScript Polywrap Client"),"."),(0,a.kt)("h2",{id:"prerequisites"},(0,a.kt)("strong",{parentName:"h2"},"Prerequisites")),(0,a.kt)("p",null,"You'll need the following NPM packages installed before testing your wrap:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://www.npmjs.com/package/@polywrap/client-js"},(0,a.kt)("inlineCode",{parentName:"a"},"@polywrap/client-js"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://www.npmjs.com/package/@polywrap/cli-js"},(0,a.kt)("inlineCode",{parentName:"a"},"@polywrap/cli-js"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://www.npmjs.com/package/jest"},(0,a.kt)("inlineCode",{parentName:"a"},"jest")))),(0,a.kt)("h2",{id:"project-setup"},(0,a.kt)("strong",{parentName:"h2"},"Project Setup")),(0,a.kt)("p",null,"The tests we'll be developing will live next to your wrap's source-code. Polywrap has published pre-configured projects for both ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/polywrap/toolchain/tree/origin-0.10/packages/templates/wasm/rust"},(0,a.kt)("inlineCode",{parentName:"a"},"wasm/rust"))," and ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/polywrap/toolchain/tree/origin-0.10/packages/templates/wasm/assemblyscript"},(0,a.kt)("inlineCode",{parentName:"a"},"wasm/assemblyscript"))," wraps. You can use & reference these when configuring your own project.  "),(0,a.kt)("p",null,"In this tutorial we'll assume a fresh ",(0,a.kt)("inlineCode",{parentName:"p"},"wasm/assemblyscript")," project has been created via the ",(0,a.kt)("inlineCode",{parentName:"p"},"polywrap create wasm assemblyscript ...")," CLI command."),(0,a.kt)("h2",{id:"build-the-wrap"},(0,a.kt)("strong",{parentName:"h2"},"Build The Wrap")),(0,a.kt)("p",null,"Before any tests can be run, we must ensure the wrap has been freshly built. This will ensure we test against the latest version of the wrap's source-code.  "),(0,a.kt)("p",null,"When using ",(0,a.kt)("inlineCode",{parentName:"p"},"jest"),", we leverage the ",(0,a.kt)("inlineCode",{parentName:"p"},"beforeAll")," function to do this. Additionally, the ",(0,a.kt)("inlineCode",{parentName:"p"},"@polywrap/cli-js")," package makes it easy to invoke the ",(0,a.kt)("inlineCode",{parentName:"p"},"polywrap build")," CLI command to build your wrap."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},'import { Commands } from "@polywrap/cli-js";\n\ndescribe("e2e Wrap Tests", () => {\n  beforeAll(async () => {\n        const result = await Commands.build({}, {\n      cwd: `${__dirname}/../../`\n    });\n\n    if (result.exitCode !== 0) {\n      console.log(result.stdout);\n      console.error(result.stderr);\n      fail("Failed to build wrapper.");\n    }\n  });\n});\n')),(0,a.kt)("p",null,"This should result in a wrap package being emitted to the ",(0,a.kt)("inlineCode",{parentName:"p"},"build/")," directory."),(0,a.kt)("h2",{id:"configure-a-polywrap-client"},(0,a.kt)("strong",{parentName:"h2"},"Configure a Polywrap Client")),(0,a.kt)("p",null,"Before we create a new Polywrap client, we must create a configuration for it to use. This can be done through use of the ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/polywrap/javascript-client/tree/origin-dev/packages/client-config-builder"},(0,a.kt)("inlineCode",{parentName:"a"},"ClientConfigBuilder")),". In the case of this example we'll be using the ",(0,a.kt)("a",{parentName:"p",href:"/concepts/plugins#default-plugin-wraps"},"default configuration")," bundle. If your wrap requires any custom integration dependencies like plugins or ",(0,a.kt)("a",{parentName:"p",href:"/concepts/env-variables"},"environment variables"),", then now would be the time to configure this."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},'import {\n  ClientConfigBuilder,\n  PolywrapClient\n} from "@polywrap/client-js";\n\ndescribe("e2e Wrap Tests", () => {\n    const config = new ClientConfigBuilder()\n  .addDefaults()\n  .build();\n\n  const client = new PolywrapClient(config);\n  ...\n});\n')),(0,a.kt)("h2",{id:"load-the-wrap"},(0,a.kt)("strong",{parentName:"h2"},"Load The Wrap")),(0,a.kt)("p",null,"We'll be loading our wrap directly from the ",(0,a.kt)("inlineCode",{parentName:"p"},"build/")," directory in the file-system. This can be accomplished in 1 of 2 ways:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Package Embedding")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},'import { WasmPackage } from "@polywrap/wasm-js";\nimport fs from "fs";\n...\nconst buildDir = `${__dirname}/../../build`;\nconst embedPackage = WasmPackage.from(\n  fs.readFileSync(`${buildDir}/wrap.info`),\n  fs.readFileSync(`${buildDir}/wrap.wasm`)\n);\n\nconst uri = "wrap://embed/test-wrapper";\n\nconst config = new ClientConfigBuilder()\n  .addPackage(uri, embedPackage)\n  .build();\n')),(0,a.kt)("ol",{start:2},(0,a.kt)("li",{parentName:"ol"},"File-System URIs")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"const buildDir = `${__dirname}/../../build`;\nconst uri = `wrap://file/${buildDir}`;\n")),(0,a.kt)("p",null,"In both cases, you end up with a ",(0,a.kt)("inlineCode",{parentName:"p"},"uri")," which can be used to invoke your wrap through the client."),(0,a.kt)("h2",{id:"test-your-wrap"},(0,a.kt)("strong",{parentName:"h2"},"Test Your Wrap")),(0,a.kt)("p",null,"Now that we have a ",(0,a.kt)("inlineCode",{parentName:"p"},"client")," invoke wraps, and a ",(0,a.kt)("inlineCode",{parentName:"p"},"uri")," to reference our wrap, we're ready to write some tests."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},'  test("Test Case", async () => {\n    const result = await client.invoke({\n      uri,\n      method: "sampleMethod",\n      args: {\n        arg: "foo bar baz"\n      }\n    });\n\n    expect(result.ok).toBe(true);\n    if (!result.ok) fail(result.error);\n\n    expect(result.value).toMatchObject({\n      result: "foo bar baz"\n    });\n  });\n')),(0,a.kt)("h2",{id:"type-safety"},(0,a.kt)("strong",{parentName:"h2"},"Type Safety")),(0,a.kt)("p",null,"In the example above, it shows the use of the ",(0,a.kt)("inlineCode",{parentName:"p"},"client.invoke(...)\nIn the example above, it shows the use of the "),"client.invoke(...)` method, which is generic. This means that if your wrap's schema changes, and (for example) the method being called no longer exists or its types change, the test will fail."),(0,a.kt)("p",null,"In order to help ensure this can be caught sooner, and easier to debug, we suggest generating TypeScript types for your wrap's schema. All you need is an ",(0,a.kt)("inlineCode",{parentName:"p"},"app/typescript")," ",(0,a.kt)("inlineCode",{parentName:"p"},"polywrap.yaml")," manifest like so:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"format: 0.3.0\nproject:\n  name: sample-typescript-type-generation\n  type: app/typescript\nsource:\n  schema: ./schema.graphql\n")),(0,a.kt)("p",null,"And an import schema like so:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-graphql"},'#import * into Wrapper from "wrap://file/build"\n')),(0,a.kt)("p",null,"We suggest putting these files in a folder next to your tests, for example ",(0,a.kt)("inlineCode",{parentName:"p"},"src/__tests__/types/"),". Once here, you can generate types by simply running the following command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"polywrap codegen -m ./src/__tests__/types/polywrap.yaml -g ./src/__tests__/types/wrap\n")),(0,a.kt)("p",null,"With this done, you can now rewrite the test above in a type-safe way."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},'  test("Test Case", async () => {\n    const result = await Wrapper_Module.sampleMethod({\n      arg: "foo bar baz"\n    }, client, uri);\n\n    expect(result.ok).toBe(true);\n    if (!result.ok) fail(result.error);\n\n    expect(result.value.result).toBe("foo bar baz");\n  });\n')),(0,a.kt)("p",null,"debug, we suggest generating TypeScript types for your wrap's schema. All you need is an ",(0,a.kt)("inlineCode",{parentName:"p"},"app/typescript")," ",(0,a.kt)("inlineCode",{parentName:"p"},"polywrap.yaml")," manifest like so:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"format: 0.3.0\nproject:\n  name: sample-typescript-type-generation\n  type: app/typescript\nsource:\n  schema: ./schema.graphql\n")),(0,a.kt)("p",null,"We suggesting putting this ",(0,a.kt)("inlineCode",{parentName:"p"},"polywrap.yaml")," manifest in a folder next to your tests like ",(0,a.kt)("inlineCode",{parentName:"p"},"src/__tests__/types/"),". Once here, you can generate types by simply running the following command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"polywrap codegen -m ./src/__tests__/types/polywrap.yaml -g ./src/__tests__/types/wrap\n")),(0,a.kt)("p",null,"With this done, you can now rewrite the test above in a type-safe way."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},'import { Wrapper_Module } from "./types/wrap";\n...\n  test("Test Case", async () => {\n    const result = await Wrapper_Module.sampleMethod({\n      arg: "foo bar baz"\n    }, client, uri);\n\n    expect(result.ok).toBe(true);\n    if (!result.ok) fail(result.error);\n\n    expect(result.value.result).toBe("foo bar baz");\n  });\n')),(0,a.kt)("h2",{id:"conclusion"},(0,a.kt)("strong",{parentName:"h2"},"Conclusion")),(0,a.kt)("p",null,"And that's a wrap!"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},'import { Commands } from "@polywrap/cli-js";\nimport {\n  ClientConfigBuilder,\n  PolywrapClient\n} from "@polywrap/client-js";\nimport { Wrapper_Module } from "./types/wrap";\n\njest.setTimeout(50000);\n\ndescribe("e2e Wrapper Tests", () => {\n  const config = new ClientConfigBuilder()\n  .addDefaults()\n  .build();\n\n  const client = new PolywrapClient(config);\n\n  const buildDir = `${__dirname}/../../build`;\n  const uri = `wrap://file/${buildDir}`;\n\n  beforeAll(async () => {\n    const result = await Commands.build({}, {\n      cwd: `${__dirname}/../../`\n    });\n\n    if (result.exitCode !== 0) {\n      console.log(result.stdout);\n      console.error(result.stderr);\n      fail("Failed to build wrapper.");\n    }\n  });\n\n  test("Test Case", async () => {\n    const result = await Wrapper_Module.sampleMethod({\n      arg: "foo bar baz"\n    }, client, uri);\n\n    expect(result.ok).toBe(true);\n    if (!result.ok) fail(result.error);\n\n    expect(result.value.result).toBe("foo bar baz");\n  });\n});\n')),(0,a.kt)("p",null,"If you'd like to see an in-production wrap w/ tests in TypeScript, checkout the ethereum wrap's tests ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/polywrap/ethereum/blob/main/wrap/tests/e2e.spec.ts"},"here"),"."))}m.isMDXComponent=!0}}]);