"use strict";(self.webpackChunk_polywrap_docs=self.webpackChunk_polywrap_docs||[]).push([[4596],{3905:(e,t,r)=>{r.d(t,{Zo:()=>u,kt:()=>g});var n=r(7294);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function p(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function o(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?p(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):p(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function i(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},p=Object.keys(e);for(n=0;n<p.length;n++)r=p[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);for(n=0;n<p.length;n++)r=p[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var l=n.createContext({}),s=function(e){var t=n.useContext(l),r=t;return e&&(r="function"==typeof e?e(t):o(o({},t),e)),r},u=function(e){var t=s(e.components);return n.createElement(l.Provider,{value:t},e.children)},c="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var r=e.components,a=e.mdxType,p=e.originalType,l=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),c=s(r),d=a,g=c["".concat(l,".").concat(d)]||c[d]||m[d]||p;return r?n.createElement(g,o(o({ref:t},u),{},{components:r})):n.createElement(g,o({ref:t},u))}));function g(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var p=r.length,o=new Array(p);o[0]=d;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i[c]="string"==typeof e?e:a,o[1]=i;for(var s=2;s<p;s++)o[s]=r[s];return n.createElement.apply(null,o)}return n.createElement.apply(null,r)}d.displayName="MDXCreateElement"},8022:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>m,frontMatter:()=>p,metadata:()=>i,toc:()=>s});var n=r(7462),a=(r(7294),r(3905));const p={id:"in-typescript",title:"Testing Wrappers In TypeScript"},o=void 0,i={unversionedId:"tutorials/testing-wrappers/in-typescript",id:"tutorials/testing-wrappers/in-typescript",title:"Testing Wrappers In TypeScript",description:"Introduction",source:"@site/docs/tutorials/testing-wrappers/in-typescript.md",sourceDirName:"tutorials/testing-wrappers",slug:"/tutorials/testing-wrappers/in-typescript",permalink:"/tutorials/testing-wrappers/in-typescript",draft:!1,editUrl:"https://github.com/polywrap/documentation/tree/main/src/docs/tutorials/testing-wrappers/in-typescript.md",tags:[],version:"current",frontMatter:{id:"in-typescript",title:"Testing Wrappers In TypeScript"},sidebar:"docs",previous:{title:"Default plugins",permalink:"/tutorials/create-wasm-wrappers/default-plugins"},next:{title:"Configure Polywrap infrastructure pipeline",permalink:"/tutorials/testing-wrappers/infra-pipeline"}},l={},s=[{value:"<strong>Introduction</strong>",id:"introduction",level:2},{value:"<strong>Prerequisites</strong>",id:"prerequisites",level:2},{value:"<strong>Project Setup</strong>",id:"project-setup",level:2},{value:"<strong>Build The Wrapper</strong>",id:"build-the-wrapper",level:2},{value:"<strong>Configure a Polywrap Client</strong>",id:"configure-a-polywrap-client",level:2},{value:"<strong>Load The Wrapper</strong>",id:"load-the-wrapper",level:2},{value:"<strong>Test Your Wrapper</strong>",id:"test-your-wrapper",level:2},{value:"<strong>Type Safety</strong>",id:"type-safety",level:2},{value:"<strong>Conclusion</strong>",id:"conclusion",level:2}],u={toc:s},c="wrapper";function m(e){let{components:t,...r}=e;return(0,a.kt)(c,(0,n.Z)({},u,r,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"introduction"},(0,a.kt)("strong",{parentName:"h2"},"Introduction")),(0,a.kt)("p",null,"In this tutorial we'll learn how to develop custom end to end (e2e) tests for your wrapper in TypeScript. These tests will be make calls into your wrapper using the ",(0,a.kt)("a",{parentName:"p",href:"../../reference/clients/js/client-js"},"JavaScript / TypeScript Polywrap Client"),"."),(0,a.kt)("h2",{id:"prerequisites"},(0,a.kt)("strong",{parentName:"h2"},"Prerequisites")),(0,a.kt)("p",null,"You'll need the following NPM packages installed before testing your wrapper:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"../../reference/clients/js/client-js"},(0,a.kt)("inlineCode",{parentName:"a"},"@polywrap/client-js"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://www.npmjs.com/package/@polywrap/cli-js"},(0,a.kt)("inlineCode",{parentName:"a"},"@polywrap/cli-js"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://www.npmjs.com/package/jest"},(0,a.kt)("inlineCode",{parentName:"a"},"jest")))),(0,a.kt)("h2",{id:"project-setup"},(0,a.kt)("strong",{parentName:"h2"},"Project Setup")),(0,a.kt)("p",null,"The tests we'll be developing will live next to your wrapper's source-code. Polywrap has published pre-configured projects for both ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/polywrap/toolchain/tree/origin-0.10/packages/templates/wasm/rust"},(0,a.kt)("inlineCode",{parentName:"a"},"wasm/rust"))," and ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/polywrap/toolchain/tree/origin-0.10/packages/templates/wasm/assemblyscript"},(0,a.kt)("inlineCode",{parentName:"a"},"wasm/assemblyscript"))," wrappers. You can use & reference these when configuring your own project.  "),(0,a.kt)("p",null,"In this tutorial we'll assume a fresh ",(0,a.kt)("inlineCode",{parentName:"p"},"wasm/assemblyscript")," project has been created via the ",(0,a.kt)("inlineCode",{parentName:"p"},"polywrap create wasm assemblyscript ...")," CLI command."),(0,a.kt)("h2",{id:"build-the-wrapper"},(0,a.kt)("strong",{parentName:"h2"},"Build The Wrapper")),(0,a.kt)("p",null,"Before any tests can be run, we must ensure the wrapper has been freshly built. This will ensure we test against the latest version of the wrapper's source-code.  "),(0,a.kt)("p",null,"When using ",(0,a.kt)("inlineCode",{parentName:"p"},"jest"),", we leverage the ",(0,a.kt)("inlineCode",{parentName:"p"},"beforeAll")," function to do this. Additionally, the ",(0,a.kt)("inlineCode",{parentName:"p"},"@polywrap/cli-js")," package makes it easy to invoke the ",(0,a.kt)("inlineCode",{parentName:"p"},"polywrap build")," CLI command to build your wrapper."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},'import { Commands } from "@polywrap/cli-js";\n\ndescribe("e2e Wrapper Tests", () => {\n  beforeAll(async () => {\n        const result = await Commands.build({}, {\n      cwd: `${__dirname}/../../`\n    });\n\n    if (result.exitCode !== 0) {\n      console.log(result.stdout);\n      console.error(result.stderr);\n      fail("Failed to build wrapper.");\n    }\n  });\n});\n')),(0,a.kt)("p",null,"This should result in a wrapper package being emitted to the ",(0,a.kt)("inlineCode",{parentName:"p"},"build/")," directory."),(0,a.kt)("h2",{id:"configure-a-polywrap-client"},(0,a.kt)("strong",{parentName:"h2"},"Configure a Polywrap Client")),(0,a.kt)("p",null,"Before we create a new Polywrap client, we must create a configuration for it to use. This can be done through use of the ",(0,a.kt)("a",{parentName:"p",href:"/reference/clients/js/client-config-builder-js"},(0,a.kt)("inlineCode",{parentName:"a"},"ClientConfigBuilder")),". In the case of this example we'll be using the ",(0,a.kt)("a",{parentName:"p",href:"/tutorials/understanding-plugins#default-plugin-wrappers"},"default configuration")," bundle. If your wrapper requires any custom integration dependencies like ",(0,a.kt)("a",{parentName:"p",href:"/concepts/plugin-wraps"},"plugins")," or ",(0,a.kt)("a",{parentName:"p",href:"/concepts/envs"},"environment variables"),", then now would be the time to configure this."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},'import {\n  ClientConfigBuilder,\n  PolywrapClient\n} from "@polywrap/client-js";\n\ndescribe("e2e Wrapper Tests", () => {\n    const config = new ClientConfigBuilder()\n  .addDefaults()\n  .build();\n\n  const client = new PolywrapClient(config);\n  ...\n});\n')),(0,a.kt)("h2",{id:"load-the-wrapper"},(0,a.kt)("strong",{parentName:"h2"},"Load The Wrapper")),(0,a.kt)("p",null,"We'll be loading our wrapper directly from the ",(0,a.kt)("inlineCode",{parentName:"p"},"build/")," directory in the file-system. This can be accomplished in 1 of 2 ways:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Package Embedding")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},'import { WasmPackage } from "@polywrap/wasm-js";\nimport fs from "fs";\n...\nconst buildDir = `${__dirname}/../../build`;\nconst embedPackage = WasmPackage.from(\n  fs.readFileSync(`${buildDir}/wrap.info`),\n  fs.readFileSync(`${buildDir}/wrap.wasm`)\n);\n\nconst uri = "wrap://embed/test-wrapper";\n\nconst config = new ClientConfigBuilder()\n  .addPackage(uri, embedPackage)\n  .build();\n')),(0,a.kt)("ol",{start:2},(0,a.kt)("li",{parentName:"ol"},"File-System URIs")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"const buildDir = `${__dirname}/../../build`;\nconst uri = `wrap://file/${buildDir}`;\n")),(0,a.kt)("p",null,"In both cases, you end up with a ",(0,a.kt)("inlineCode",{parentName:"p"},"uri")," which can be used to invoke your wrapper through the client."),(0,a.kt)("h2",{id:"test-your-wrapper"},(0,a.kt)("strong",{parentName:"h2"},"Test Your Wrapper")),(0,a.kt)("p",null,"Now that we have a ",(0,a.kt)("inlineCode",{parentName:"p"},"client")," invoke wrappers, and a ",(0,a.kt)("inlineCode",{parentName:"p"},"uri")," to reference our wrapper, we're ready to write some tests."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},'  test("Test Case", async () => {\n    const result = await client.invoke({\n      uri,\n      method: "sampleMethod",\n      args: {\n        arg: "foo bar baz"\n      }\n    });\n\n    expect(result.ok).toBe(true);\n    if (!result.ok) fail(result.error);\n\n    expect(result.value).toMatchObject({\n      result: "foo bar baz"\n    });\n  });\n')),(0,a.kt)("h2",{id:"type-safety"},(0,a.kt)("strong",{parentName:"h2"},"Type Safety")),(0,a.kt)("p",null,"In the example above, it shows the use of the ",(0,a.kt)("inlineCode",{parentName:"p"},"client.invoke(...)\nIn the example above, it shows the use of the "),"client.invoke(...)` method, which is generic. This means that if your wrapper's schema changes, and (for example) the method being called no longer exists or its types change, the test will fail."),(0,a.kt)("p",null,"In order to help ensure this can be caught sooner, and easier to debug, we suggest generating TypeScript types for your wrapper's schema. All you need is an ",(0,a.kt)("inlineCode",{parentName:"p"},"app/typescript")," ",(0,a.kt)("inlineCode",{parentName:"p"},"polywrap.yaml")," manifest like so:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"format: 0.3.0\nproject:\n  name: sample-typescript-type-generation\n  type: app/typescript\nsource:\n  schema: ./schema.graphql\n")),(0,a.kt)("p",null,"And an import schema like so:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-graphql"},'#import * into Wrapper from "wrap://file/build"\n')),(0,a.kt)("p",null,"We suggest putting these files in a folder next to your tests, for example ",(0,a.kt)("inlineCode",{parentName:"p"},"src/__tests__/types/"),". Once here, you can generate types by simply running the following command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"polywrap codegen -m ./src/__tests__/types/polywrap.yaml -g ./src/__tests__/types/wrap\n")),(0,a.kt)("p",null,"With this done, you can now rewrite the test above in a type-safe way."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},'  test("Test Case", async () => {\n    const result = await Wrapper_Module.sampleMethod({\n      arg: "foo bar baz"\n    }, client, uri);\n\n    expect(result.ok).toBe(true);\n    if (!result.ok) fail(result.error);\n\n    expect(result.value.result).toBe("foo bar baz");\n  });\n')),(0,a.kt)("p",null,"debug, we suggest generating TypeScript types for your wrapper's schema. All you need is an ",(0,a.kt)("inlineCode",{parentName:"p"},"app/typescript")," ",(0,a.kt)("inlineCode",{parentName:"p"},"polywrap.yaml")," manifest like so:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"format: 0.3.0\nproject:\n  name: sample-typescript-type-generation\n  type: app/typescript\nsource:\n  schema: ./schema.graphql\n")),(0,a.kt)("p",null,"We suggesting putting this ",(0,a.kt)("inlineCode",{parentName:"p"},"polywrap.yaml")," manifest in a folder next to your tests like ",(0,a.kt)("inlineCode",{parentName:"p"},"src/__tests__/types/"),". Once here, you can generate types by simply running the following command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"polywrap codegen -m ./src/__tests__/types/polywrap.yaml -g ./src/__tests__/types/wrap\n")),(0,a.kt)("p",null,"With this done, you can now rewrite the test above in a type-safe way."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},'import { Wrapper_Module } from "./types/wrap";\n...\n  test("Test Case", async () => {\n    const result = await Wrapper_Module.sampleMethod({\n      arg: "foo bar baz"\n    }, client, uri);\n\n    expect(result.ok).toBe(true);\n    if (!result.ok) fail(result.error);\n\n    expect(result.value.result).toBe("foo bar baz");\n  });\n')),(0,a.kt)("h2",{id:"conclusion"},(0,a.kt)("strong",{parentName:"h2"},"Conclusion")),(0,a.kt)("p",null,"And that's a wrap!"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},'import { Commands } from "@polywrap/cli-js";\nimport {\n  ClientConfigBuilder,\n  PolywrapClient\n} from "@polywrap/client-js";\nimport { Wrapper_Module } from "./types/wrap";\n\njest.setTimeout(50000);\n\ndescribe("e2e Wrapper Tests", () => {\n  const config = new ClientConfigBuilder()\n  .addDefaults()\n  .build();\n\n  const client = new PolywrapClient(config);\n\n  const buildDir = `${__dirname}/../../build`;\n  const uri = `wrap://file/${buildDir}`;\n\n  beforeAll(async () => {\n    const result = await Commands.build({}, {\n      cwd: `${__dirname}/../../`\n    });\n\n    if (result.exitCode !== 0) {\n      console.log(result.stdout);\n      console.error(result.stderr);\n      fail("Failed to build wrapper.");\n    }\n  });\n\n  test("Test Case", async () => {\n    const result = await Wrapper_Module.sampleMethod({\n      arg: "foo bar baz"\n    }, client, uri);\n\n    expect(result.ok).toBe(true);\n    if (!result.ok) fail(result.error);\n\n    expect(result.value.result).toBe("foo bar baz");\n  });\n});\n')),(0,a.kt)("p",null,"If you'd like to see an in-production wrapper w/ tests in TypeScript, checkout the ethereum wrapper's tests ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/polywrap/ethereum/blob/main/wrapper/tests/e2e.spec.ts"},"here"),"."))}m.isMDXComponent=!0}}]);